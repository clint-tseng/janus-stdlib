// Generated by CoffeeScript 1.11.1
(function() {
  var $, Base, DomView, Enum, EnumAttributeEditView, List, Varying, asList, find, from, isArray, isPrimitive, ref, ref1, ref2, stringifier, template, uniqueId,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  ref = require('janus'), Varying = ref.Varying, DomView = ref.DomView, from = ref.from, template = ref.template, find = ref.find, Base = ref.Base, List = ref.List;

  Enum = require('janus').attribute.Enum;

  ref1 = require('janus').util, isArray = ref1.isArray, isPrimitive = ref1.isPrimitive, uniqueId = ref1.uniqueId;

  ref2 = require('../util/util'), stringifier = ref2.stringifier, asList = ref2.asList;

  $ = require('../util/dollar');

  EnumAttributeEditView = (function(superClass) {
    extend(EnumAttributeEditView, superClass);

    function EnumAttributeEditView() {
      return EnumAttributeEditView.__super__.constructor.apply(this, arguments);
    }

    EnumAttributeEditView.prototype.dom = function() {
      return $('<select/>');
    };

    EnumAttributeEditView.prototype._updateVal = function(select) {
      var _id, id, ref3, value;
      if (this._valueMap == null) {
        return;
      }
      ref3 = this._valueMap;
      for (_id in ref3) {
        value = ref3[_id];
        if (value === this.subject.getValue()) {
          id = _id;
          break;
        }
      }
      if (id != null) {
        return select.val(id);
      }
    };

    EnumAttributeEditView.prototype._render = function() {
      var select;
      select = this.dom();
      this._valueMap = {};
      this._textBindingsMap = {};
      Varying.ly(this.subject.values()).map(asList).react((function(_this) {
        return function(list) {
          var i, idx, len, option, options, ref3, results;
          _this._removeAll(select);
          if (_this.subject.nullable === true) {
            list = new List([null]).concat(list);
          }
          _this._options = options = list.map(function(item) {
            var id, option, textBinding;
            option = $('<option/>');
            textBinding = stringifier(_this).flatMap(function(f) {
              return f(item);
            }).react(function(text) {
              return option.text(text);
            });
            id = _this._generateId(item);
            option.attr('value', id);
            _this._valueMap[id] = item;
            _this._textBindingsMap[id] = textBinding;
            return option;
          });
          _this.listenTo(options, 'added', function(option, idx) {
            return _this._add(select, option, idx);
          });
          _this.listenTo(options, 'removed', function(option) {
            return _this._remove(option);
          });
          ref3 = options.list;
          results = [];
          for (idx = i = 0, len = ref3.length; i < len; idx = ++i) {
            option = ref3[idx];
            results.push(_this._add(select, option, idx));
          }
          return results;
        };
      })(this));
      return select;
    };

    EnumAttributeEditView.prototype._generateId = function(value) {
      if (value == null) {
        return toString.call(value);
      } else if (isPrimitive(value)) {
        return value.toString();
      } else if (value._id != null) {
        return value._id.toString();
      } else {
        return uniqueId().toString();
      }
    };

    EnumAttributeEditView.prototype._removeAll = function(select) {
      var _, binding, ref3;
      if (this._textBindingsMap != null) {
        ref3 = this._textBindingsMap;
        for (_ in ref3) {
          binding = ref3[_];
          binding.stop();
        }
      }
      this._textBindingsMap = {};
      this._valueMap = {};
      if (this._options != null) {
        this.unlistenTo(this._options);
        this._options.destroy();
      }
      return select.empty();
    };

    EnumAttributeEditView.prototype._add = function(dom, option, idx) {
      var children;
      children = dom.children();
      if (idx === 0) {
        dom.prepend(option);
      } else if (idx === children.length) {
        dom.append(option);
      } else {
        children.eq(idx).before(option);
      }
      return this._updateVal(dom);
    };

    EnumAttributeEditView.prototype._remove = function(option) {
      var id;
      id = option.attr('value');
      this._textBindingsMap[id].stop();
      delete this._textBindingsMap[id];
      delete this._valueMap[id];
      return option.remove();
    };

    EnumAttributeEditView.prototype._wireEvents = function() {
      var select, subject, update;
      select = this.artifact();
      subject = this.subject;
      subject.watchValue().react((function(_this) {
        return function() {
          return _this._updateVal(select);
        };
      })(this));
      update = (function(_this) {
        return function() {
          var selectedOption;
          selectedOption = select.children(':selected');
          if (selectedOption.length === 0) {
            selectedOption = select.children(':first');
          }
          return subject.setValue(_this._valueMap[selectedOption.val()]);
        };
      })(this);
      select.on('change input', update);
      return update();
    };

    return EnumAttributeEditView;

  })(DomView);

  module.exports = {
    EnumAttributeEditView: EnumAttributeEditView,
    registerWith: function(library) {
      return library.register(Enum, EnumAttributeEditView, {
        context: 'edit'
      });
    }
  };

}).call(this);
